<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Recorder Debug Page</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 18px; }
    pre { background:#f6f6f6; border:1px solid #ddd; padding:12px; white-space:pre-wrap; }
    #status { margin:10px 0; font-weight:600; }
    button { padding:8px 10px; margin-right:8px; }
  </style>
</head>
<body>
  <h2>Recorder Debug Page</h2>
  <div id="status">Status: starting…</div>

  <div>
    <button id="testBtn">Test getUserMedia</button>
    <button id="showFilesBtn">List /uploads (server)</button>
  </div>

  <h3>Console output</h3>
  <pre id="out">— ready —</pre>

<script>
const out = document.getElementById('out');
const status = document.getElementById('status');

function log(...args){
  console.log(...args);
  out.textContent += args.map(a => (typeof a === 'string' ? a : JSON.stringify(a))).join(' ') + '\n';
  window.scrollTo(0,document.body.scrollHeight);
}

window.onerror = function(message, source, lineno, colno, error){
  log('Window error:', message, 'at', source + ':' + lineno + ':' + colno, error && error.stack);
  status.textContent = 'Status: error (see output)';
};

window.addEventListener('unhandledrejection', ev => {
  log('Unhandled promise rejection:', ev.reason);
  status.textContent = 'Status: error (see output)';
});

document.getElementById('testBtn').addEventListener('click', async () => {
  status.textContent = 'Status: requesting camera permission...';
  try {
    const s = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    log('getUserMedia OK — tracks:', s.getTracks().map(t=>t.kind+'/'+t.label));
    s.getTracks().forEach(t => t.stop());
    status.textContent = 'Status: camera OK (permission granted)';
  } catch (err) {
    log('getUserMedia failed:', err && err.message || err);
    status.textContent = 'Status: camera denied or not available';
  }
});

document.getElementById('showFilesBtn').addEventListener('click', async () => {
  status.textContent = 'Status: requesting /uploads listing...';
  try {
    // your server does not expose uploads by default; this checks /uploads/audit.log (if readable)
    const r = await fetch('/uploads/audit.log', { method: 'GET' });
    if (!r.ok) {
      log('Fetch /uploads/audit.log returned', r.status, r.statusText);
      status.textContent = 'Status: /uploads not readable publicly (expected)';
      return;
    }
    const text = await r.text();
    log('/uploads/audit.log content:\n' + text);
    status.textContent = 'Status: fetched audit.log';
  } catch (err) {
    log('Error fetching /uploads/audit.log:', err && err.message || err);
    status.textContent = 'Status: cannot fetch /uploads (likely protected)';
  }
});

status.textContent = 'Status: ready — click "Test getUserMedia" to check camera permission or "List /uploads" for server file check';
</script>
</body>
</html>
